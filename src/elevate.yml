
- job:
    name: elevate
    project-type: matrix
    node: 'gcs'
    parameters:
      - string:
          name: JENKINS_TAG
          default: '**'
    .osarch-axes:
      os: ['windows']
      arch: ['386', 'amd64']
    triggers:
      - pollscm
    scm:
      .git: &elevate-git
        host: github.com
        repo: itchio/elevate
        branches: '$JENKINS_TAG'
    wrappers:
      - ansi-color
      - inject:
          groovy-script-content:
            .export-jenkins-version:
    workspace: 'workspace/elevate/$JENKINS_OS-$JENKINS_ARCH'
    builders:
      - shell: |
          cppcheck --error-exitcode=1 src
      - shell: |
          export ELEVATE_CFLAGS="-DELEVATE_VERSION=\\\"$JENKINS_VERSION\\\""

          if [[ "$JENKINS_ARCH" == "amd64" ]]; then
            export PATH=/mingw64/bin:$PATH
          else
            export PATH=/mingw32/bin:$PATH
          fi

          make
          file elevate.exe

          if [ "$JENKINS_DEPLOY" = "1" ]; then
            7za a elevate.7z $elevate.exe
            echo $JENKINS_VERSION > LATEST
          fi
    publishers:
      - .deploy-to-gcs:
          package: 'elevate'

- .trigger-job:
    project: elevate
    git: *elevate-git
