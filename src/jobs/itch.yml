
- job:
    name: itch
    .matrix-project:
      combination-filter: '!(JENKINS_OS == "darwin" && JENKINS_ARCH == "386") && !(JENKINS_OS == "windows" && JENKINS_ARCH == "amd64")'
    parameters:
      - ..base-parameters:
    wrappers:
      - ..base-wrappers:
      - workspace-cleanup:
          delete-dirs: true
      - credentials-binding:
          - file:
              credential-id: 33fed761-e912-43d1-bea8-54e579bfc0b8
              variable: CODESIGN_SPC_PATH
          - file:
              credential-id: fcf86672-e97c-4896-a9d5-8e50c384c2ff
              variable: CODESIGN_KEY_PATH
          - text:
              credential-id: 85395ee8-f0b4-4adc-8100-aee9509ab159
              variable: COVERALLS_REPO_TOKEN
    scm:
      - .git: &itch-git
          host: github.com
          repo: itchio/itch
          branches: '$JENKINS_TAG'
    builders:
      - shell: |
          node --version
          npm --version
      - shell: |
          npm config set spin false
          npm install -g grunt-cli
          export PATH=$PATH:$PWD/node_modules/.bin
          npm install
          npm test
      - shell: |
          if [ "$JENKINS_OS-$JENKINS-ARCH" = "linux-amd64" ]; then
            export COVERALLS_SERVICE_NAME=jenkins
            export COVERALLS_SERVICE_JOB_ID=$BUILD_ID
            npm run coveralls
          fi
      - shell: |
          if [ "$JENKINS_DEPLOY" = "1" ]; then
            npm install -g babel-cli@6

            TASKS="prepare electron:$JENKINS_OS-$JENKINS_ARCH"

            if [ "$JENKINS_OS" = "windows" ]; then
              TASKS="$TASKS create-windows-installer:$JENKINS_ARCH"
            fi

            grunt -v $TASKS

            if [ "$JENKINS_OS" = "darwin" ]; then
              APP_BUILD_PATH="build/$JENKINS_TAG/itch-$JENKINS_OS-$JENKINS_ARCH"
              APP_BUNDLE_PATH="$APP_BUILD_PATH/itch.app"
              APP_ARCHIVE_PATH="$WORKSPACE/itch-mac.zip"

              codesign --deep --force --verbose --sign 'Developer ID Application: Amos Wenger (B2N6FSRTPV)' $APP_BUNDLE_PATH
              codesign --verify -vvvv $APP_BUNDLE_PATH
              spctl -a -vvvv $APP_BUNDLE_PATH

              (cd $APP_BUILD_PATH && 7za a $APP_ARCHIVE_PATH *)
              ls -lhA $APP_ARCHIVE_PATH
            fi
          fi


- ..standard-triggers:
    project: itch
    git: *itch-git
