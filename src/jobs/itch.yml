
- job:
    name: itch
    .matrix-project:
      combination-filter: '!(JENKINS_OS == "darwin" && JENKINS_ARCH == "386") && !(JENKINS_OS == "windows" && JENKINS_ARCH == "amd64")'
    parameters:
      - ..base-parameters:
    wrappers:
      - ..base-wrappers:
      - workspace-cleanup:
          delete-dirs: true
      - credentials-binding:
          - file:
              credential-id: 33fed761-e912-43d1-bea8-54e579bfc0b8
              variable: CODESIGN_SPC_PATH
          - file:
              credential-id: fcf86672-e97c-4896-a9d5-8e50c384c2ff
              variable: CODESIGN_KEY_PATH
          - text:
              credential-id: 85395ee8-f0b4-4adc-8100-aee9509ab159
              variable: COVERALLS_REPO_TOKEN
    scm:
      - .git: &itch-git
          host: github.com
          repo: itchio/itch
          branches: '$JENKINS_TAG'
    builders:
      - shell: |
          node --version
          npm --version
      - shell: |
          npm config set spin false
          npm install -g grunt-cli
          export PATH=$PATH:$PWD/node_modules/.bin
          npm install
          npm test
      - shell: |
          if [ "$JENKINS_OS-$JENKINS-ARCH" = "linux-amd64" ]; then
            export COVERALLS_SERVICE_NAME=jenkins
            export COVERALLS_SERVICE_JOB_ID=$BUILD_ID
            npm run coveralls
          fi
      - shell: |
          if [ "$JENKINS_DEPLOY" != "1" ]; then
            exit 0
          fi

          npm install -g babel-cli@6

          if [ "$JENKINS_ARCH" = "386" ]; then
            ELECTRON_ARCH="ia32"
          else
            ELECTRON_ARCH="x64"
          fi

          BUILD_PATH="build/$JENKINS_TAG/itch-$JENKINS_OS-$ELECTRON_ARCH"
          TASKS="prepare electron:$JENKINS_OS-$ELECTRON_ARCH"

          if [ "$JENKINS_OS" = "windows" ]; then
            TASKS="$TASKS create-windows-installer:$ELECTRON_ARCH"
          fi

          grunt -v $TASKS

          if [ "$JENKINS_OS" = "darwin" ]; then
            OSX_SIGN_KEY="Developer ID Application: Amos Wenger (B2N6FSRTPV)"
            ditto -v $BUILD_PATH/itch.app itch.app

            codesign --deep --force --verbose --sign "$OSX_SIGN_KEY" itch.app
            codesign --verify -vvvv itch.app
            spctl -a -vvvv itch.app

            7za a itch-mac.zip itch.app

            npm install -g appdmg
            appdmg release/appdmg.json itch-mac.dmg
          fi

          if [ "$JENKINS_OS" = "linux" ]; then
            DEB_VERSION=$(echo $JENKINS_TAG | sed 's/^v//')

            rm -rf stage2 && mkdir -p stage2/itch
            cp -rf $BUILD_PATH/* stage2/itch
            fpm --force \
              -C stage2 \
              -s dir -t deb \
              --deb-compression xz \
              -n itch \
              --description "The best way to play itch.io games" \
              --url "https://github.com/itchio/itch" \
              --version "$DEB_VERSION" \
              --maintainer "amos@itch.io" \
              --license "MIT" \
              --vendor "itch.io" \
              --category "games" \
              --after-install "$WORKSPACE/release/register-scheme-handler.sh" \
              -d "p7zip-full (> 0)" \
              itch=/opt \
              $WORKSPACE/release/itch.sh=/usr/bin/itch \
              $WORKSPACE/release/icons/icon16.png=/usr/share/icons/hicolor/16x16/apps/itch.png \
              $WORKSPACE/release/icons/icon32.png=/usr/share/icons/hicolor/32x32/apps/itch.png \
              $WORKSPACE/release/icons/icon36.png=/usr/share/icons/hicolor/36x36/apps/itch.png \
              $WORKSPACE/release/icons/icon48.png=/usr/share/icons/hicolor/48x48/apps/itch.png \
              $WORKSPACE/release/icons/icon64.png=/usr/share/icons/hicolor/64x64/apps/itch.png \
              $WORKSPACE/release/icons/icon72.png=/usr/share/icons/hicolor/72x72/apps/itch.png \
              $WORKSPACE/release/icons/icon144.png=/usr/share/icons/hicolor/144x144/apps/itch.png \
              $WORKSPACE/release/icons/icon512.png=/usr/share/icons/hicolor/512x512/apps/itch.png
          fi

- ..standard-triggers:
    project: itch
    git: *itch-git
