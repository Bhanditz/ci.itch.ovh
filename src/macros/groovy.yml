
- :export-latest-tag: |
    pattern = "[0-9][0-9]*.[0-9][0-9]*.[0-9][0-9]*"

    out = "git log --tags=$pattern --pretty=format:%d".execute().text
    versions = (out =~ pattern)
    latest = versions.collect().sort(false) { a, b ->
      [a, b]*.tokenize('.')*.collect { it as int }.with { u, v ->
        [u, v].transpose().findResult{ x, y -> x <=> y ?: null } ?: u.size() <=> v.size()
      }
    }[-1]

    props = "JENKINS_TAG = v$latest"

    latest_tag = new File('latest_tag.properties')
    revision = new File('revision.properties')

    if (latest_tag.exists() && latest_tag.text == props) {
      println "Already built ${latest_tag.text}"
      revision.text = "JENKINS_TAG = **"
    } else {
      println "Building tag ${props}"
      revision.text = props
    }

    latest_tag.text = props

- :export-jenkins-version: |
    if (JENKINS_TAG == "**") {
      return [
        JENKINS_VERSION: "head",
        JENKINS_DEPLOY: 0,
      ]
    } else {
      return [
        JENKINS_VERSION: JENKINS_TAG,
        JENKINS_DEPLOY: 1,
      ]
    }
