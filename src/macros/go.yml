
- :go-build-binary: |
    go get -d -v ./...
    go build -v -x -ldflags "{ldflags}" {pkg}
    file {exe}
    {exe} -V
    7za a {name}.7z {exe}
    echo "$TAG" > LATEST

- :go-job:
    job:
      name: '{name}'
      project-type: matrix
      execution-strategy:
        combination-filter: (os == "osx").implies(arch == "amd64")
      parameters:
        - string:
            name: TAG
            default: '**'
      axes:
        - axis:
            type: label-expression
            name: os
            values:
              - windows
              - osx
              - linux
        - axis:
            type: user-defined
            name: arch
            values:
              - 386
              - amd64
      workspace: 'workspace/{name}/$os-$arch/src/{git.host}/{git.user}/{git.name}'
      child-workspace: .
      scm:
        - .git: '{git}'
      triggers:
        - github
        - pollscm
      builders:
        - .export: |
            GOPATH=$WORKSPACE/../../../..
            GOARCH=$arch
            GO_JENKINS_LDFLAGS=-X main.version=$TAG
            CGO_ENABLED=1
            CC_FOR_TARGET=gcc
            CXX_FOR_TARGET=g++
        - .on-windows:
            - .export: Path=$Path;C:\msys64\usr\bin;C:\msys64\usr\lib\p7zip
        - .on-os-arch:
            spec: windows-386
            do: [ .export: 'Path=$Path;C:\msys64\mingw32\bin' ]
        - .on-os-arch:
            spec: windows-amd64
            do: [ .export: 'Path=$Path;C:\msys64\mingw64\bin' ]
        - .on-unix:
            - .export: PATH=$PATH:/usr/local/go/bin
        - .shell:
            .go-build-binary:
              ldflags: '$GO_JENKINS_LDFLAGS'
              name: '{exe}'
              pkg: '{pkg}'
              exe: './{exe}'
        - .batch:
            .go-build-binary:
              ldflags: '%GO_JENKINS_LDFLAGS%'
              name: '{exe}'
              pkg: '{pkg}'
              exe: '{exe}.exe'
      publishers:
        - .on-release:
            - s3:
                s3-profile: misc.amos.me
                entries:
                  - destination-bucket: 'misc.amos.me/{exe}-jenkins/$os-$arch/$TAG'
                    source-files: '{exe}.7z'
                  - destination-bucket: 'misc.amos.me/{exe}-jenkins/$os-$arch'
                    source-files: 'LATEST'
