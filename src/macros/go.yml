
- :go-job:
    job:
      name: '{name}'
      project-type: matrix
      node: 'gcs'
      execution-strategy:
        combination-filter: (JENKINS_OS == "osx").implies(JENKINS_ARCH == "amd64")
      parameters:
        - string:
            name: JENKINS_TAG
      axes:
        - axis:
            type: label-expression
            name: JENKINS_OS
            values:
              - windows
              - osx
              - linux
        - axis:
            type: user-defined
            name: JENKINS_ARCH
            values:
              - 386
              - amd64
      workspace: 'workspace/{name}/$JENKINS_OS-$JENKINS_ARCH/src/{git.host}/{git.user}/{git.name}'
      child-workspace: .
      scm:
        - .git: '{git}'
      wrappers:
        - inject:
            groovy-script-content:
              .export-jenkins-version:
      builders:
        - shell: |
              export GOPATH="$WORKSPACE/../../../.."
              export GOARCH="$JENKINS_ARCH"
              export CGO_ENABLED=1
              export CC_FOR_TARGET="gcc"
              export CXX_FOR_TARGET="g++"
              export JENKINS_LDFLAGS="-X main.version=$JENKINS_VERSION"

              TARGET={exe}
              if [[ "$JENKINS_OS" == "windows" ]]; then
                TARGET=$TARGET.exe
                if [[ "$JENKINS_ARCH" == "amd64" ]]; then
                  export PATH=/mingw64/bin:$PATH
                else
                  export PATH=/mingw32/bin:$PATH
                fi
              else
                export PATH=$PATH:/usr/local/go/bin
              fi

              go get -v -d ./...
              go build -v -ldflags "$JENKINS_LDFLAGS" {pkg}

              file $TARGET
              ./$TARGET -V
              7za a {exe}.7z $TARGET
              echo $JENKINS_VERSION > LATEST
      publishers:
        - conditional-publisher:
            .on-deploy:
              - s3:
                  s3-profile: misc.amos.me
                  entries:
                    - destination-bucket: 'misc.amos.me/{exe}-jenkins/$JENKINS_OS-$JENKINS_ARCH/$JENKINS_VERSION'
                      source-files: '{exe}.7z'
                    - destination-bucket: 'misc.amos.me/{exe}-jenkins/$JENKINS_OS-$JENKINS_ARCH'
                      source-files: 'LATEST'
