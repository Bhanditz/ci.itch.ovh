
- :go-job:
    job:
      name: '{name}'
      project-type: matrix
      node: 'gcs'
      execution-strategy:
        combination-filter: (JENKINS_OS == "darwin").implies(JENKINS_ARCH == "amd64")
      parameters:
        - string:
            name: JENKINS_TAG
            default: '**'
      axes:
        - axis:
            type: label-expression
            name: JENKINS_OS
            values:
              - windows
              - darwin
              - linux
        - axis:
            type: user-defined
            name: JENKINS_ARCH
            values:
              - 386
              - amd64
      scm:
        - .git-go: '{git}'
      triggers:
        - pollscm
      wrappers:
        - ansi-color
        - workspace-cleanup:
            delete-dirs: true
        - inject:
            groovy-script-content:
              .export-jenkins-version:
      builders:
        - shell: |
              export GOPATH="$WORKSPACE"
              export GOARCH="$JENKINS_ARCH"
              export CGO_ENABLED=1
              export CC_FOR_TARGET="gcc"
              export CXX_FOR_TARGET="g++"
              export JENKINS_LDFLAGS="-X main.version=$JENKINS_VERSION"

              TARGET={exe}
              if [ "$JENKINS_OS" = "windows" ]; then
                TARGET=$TARGET.exe
                if [ "$JENKINS_ARCH" = "amd64" ]; then
                  export PATH=/mingw64/bin:$PATH
                else
                  export PATH=/mingw32/bin:$PATH
                fi
              else
                export PATH=$PATH:/usr/local/go/bin
              fi

              JENKINS_IMPORT_PATH={git.host}/{git.repo}
              go get -v -d $JENKINS_IMPORT_PATH/...
              go build -v -ldflags "$JENKINS_LDFLAGS" $JENKINS_IMPORT_PATH/{pkg}

              file $TARGET
              ./$TARGET -V
              7za a {exe}.7z $TARGET
              echo $JENKINS_VERSION > LATEST
      publishers:
        - .deploy-to-gcs:
            package: '{exe}'
